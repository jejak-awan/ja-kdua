<?php

namespace App\Http\Controllers\Api\V1;

use App\Models\DependencyVulnerability;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Artisan;

class DependencyVulnerabilityController extends BaseApiController
{
    public function index(Request $request): \Illuminate\Http\JsonResponse
    {
        $query = DependencyVulnerability::query();

        if ($request->filled('source')) {
            $sourceRaw = $request->source;
            $source = is_string($sourceRaw) ? $sourceRaw : '';
            $query->where('source', $source);
        }

        if ($request->filled('severity')) {
            $severityRaw = $request->severity;
            $severity = is_string($severityRaw) ? $severityRaw : '';
            $query->where('severity', $severity);
        }

        if ($request->filled('status')) {
            $statusRaw = $request->status;
            $status = is_string($statusRaw) ? $statusRaw : '';
            $query->where('status', $status);
        }

        if ($request->filled('package')) {
            $packageRaw = $request->package;
            $package = is_string($packageRaw) ? $packageRaw : '';
            $query->where('package_name', 'like', "%{$package}%");
        }

        $perPageRaw = $request->input('per_page', 50);
        $perPage = is_numeric($perPageRaw) ? (int) $perPageRaw : 50;
        $vulnerabilities = $query->latest()->paginate($perPage);

        return $this->paginated($vulnerabilities, 'Vulnerabilities retrieved');
    }

    public function update(Request $request, int $id): \Illuminate\Http\JsonResponse
    {
        $vuln = DependencyVulnerability::findOrFail($id);
        /** @var DependencyVulnerability $vuln */
        $validated = $request->validate([
            'status' => 'required|in:new,acknowledged,patched,ignored',
        ]);

        $vuln->update($validated);

        return $this->success($vuln, 'Status updated');
    }

    public function runAudit(): \Illuminate\Http\JsonResponse
    {
        Artisan::call('security:audit-dependencies');

        return $this->success(null, 'Dependency audit completed');
    }

    public function statistics(): \Illuminate\Http\JsonResponse
    {
        $stats = [
            'total' => DependencyVulnerability::count(),
            'critical' => DependencyVulnerability::where('severity', 'critical')->count(),
            'high' => DependencyVulnerability::where('severity', 'high')->count(),
            'medium' => DependencyVulnerability::where('severity', 'medium')->count(),
            'low' => DependencyVulnerability::where('severity', 'low')->count(),
        ];

        return $this->success($stats, 'Vulnerability statistics retrieved');
    }
}
