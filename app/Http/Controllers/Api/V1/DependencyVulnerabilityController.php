<?php

namespace App\Http\Controllers\Api\V1;

use App\Models\DependencyVulnerability;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Artisan;

class DependencyVulnerabilityController extends BaseApiController
{
    public function index(Request $request)
    {
        $query = DependencyVulnerability::query();
        
        if ($request->filled('source')) {
            $query->where('source', $request->source);
        }
        
        if ($request->filled('severity')) {
            $query->where('severity', $request->severity);
        }
        
        if ($request->filled('status')) {
            $query->where('status', $request->status);
        }
        
        if ($request->filled('package')) {
            $query->where('package_name', 'like', "%{$request->package}%");
        }
        
        $vulnerabilities = $query->latest()->paginate($request->input('per_page', 50));
        
        return $this->paginated($vulnerabilities, 'Vulnerabilities retrieved');
    }
    
    public function update(Request $request, $id)
    {
        $vuln = DependencyVulnerability::findOrFail($id);
        
        $validated = $request->validate([
            'status' => 'required|in:new,acknowledged,patched,ignored',
        ]);
        
        $vuln->update($validated);
        
        return $this->success($vuln, 'Status updated');
    }
    
    public function runAudit()
    {
        Artisan::call('security:audit-dependencies');
        
        return $this->success(null, 'Dependency audit completed');
    }
}
